%% open the .PCD
fileID = fopen('../OPiT/gnistangtunneln-semifull-voxelized.pcd','r');

%% skip the header
for k=1:11
    tline = fgets(fileID);
end

%% set the format
formatSpec = '%f %f %f';
sizeA = [3 Inf];

A = fscanf(fileID,formatSpec,sizeA);
A = A.';

fclose(fileID);

%% try to put something atop the point cloud
w_cameracenter  = [143425.5458; 6394339.7282; 35.4776];
p_minrange      = 10;
p_maxrange      = 25;
p_range         = (12:0.2:26);
p_sample        = [239.8354; 207.1412];

%% C matrix -- calibration matrix
K = [1432, 0, 640;
     0, 1432, 480;
     0, 0, 1];

T = [0.936168046306955, -0.07229943085008331, 0.3440380522159919, 143425.5458462106; ...
     -0.3475265283978696, -0.04263812010476335, 0.9367002203339428, 6394339.728225683; ...
     -0.0530537570162973, -0.9964711651687098, -0.06504241580514886, 35.47761542402441; ...
     0, 0, 0, 1];
 
%% calculate 
size_t = size(p_range, 2);
counter = 1;
w_samples = zeros(4, size_t);

for i = p_range
    c_samplemin     = K \ [i * p_sample(1,1); i * p_sample(2,1); i];
    w_samplemin     = T * [c_samplemin; 1];
%     c_samplemax     = K \ [p_maxrange * p_sample(1,1); p_maxrange * p_sample(2,1); p_maxrange];
%     w_samplemax     = T * [c_samplemax; 1];  
%     w_samples       = [w_samplemin(1:3,:) w_samplemax(1:3,:)];
    w_samples(:,counter)  = w_samplemin;
    counter = counter+1;
end

% threshold 0.1 delta_z 0.1 range [15..25]
% w_output        = [ 143425.5458 6394339.7282 35.4776; ...
%                     143425.7050 6394339.9528 35.5748; ...
%                     143426.4609 6394340.3759 35.3052; ...
%                     143426.2820 6394341.0865 35.1930; ...
%                     143426.6524 6394342.1847 35.0957; ...
%                     143425.9659 6394342.9679 36.4973; ...
%                     143426.6897 6394343.5866 36.4533; ...
%                     143426.7589 6394344.2610 38.3915; ...
%                     143427.5726 6394345.0818 38.2862];

% threshold 0.5 delta_z 0.5 range [15..25]
% w_output        = [ 143425.5458 6394339.7282 35.4776; ...                
%                     143426.1352 6394339.8483 35.5904; ...
%                     143426.4918 6394340.0238, 35.8172; ...
%                     143426.2570 6394340.3981 35.9104; ...
%                     143426.5593 6394341.3152 35.7641; ...
%                     143428.2513 6394342.6331 35.4329; ...
%                     143428.5748 6394343.3893 35.6713; ...
%                     143424.8591 6394346.1549 39.7465; ...
%                     143424.6530 6394347.5601 37.8629; ...
%                     143424.6043 6394349.4692 41.3363]; 
                
% w_output        = [ 143425.5458 6394339.7282 35.4776; ...
%                     143426.8770 6394340.0674 36.4723; ...
%                     143427.1853 6394341.0884 36.0889; ...
%                     143428.2329 6394341.9921 35.6395; ...
%                     143427.7359 6394342.7898 36.0100; ...
%                     143428.1049 6394343.6650 35.9862; ...
%                     143428.8203 6394345.3527 35.2654; ...
%                     
%                     143428.7359 6394345.7898 36.0100; ...
%                     143429.1049 6394346.6650 35.9862; ...
%                     143429.3203 6394347.3527 35.2654];
                    
% w_output =  [143442.7589514623 6394357.384494003 38.45321393071208; ...
%              143441.7918847976 6394357.552393478 38.51032425370067; ...
%              143442.5353419967 6394355.829716453 37.80889172409661; ...
%              143440.5975704645 6394358.049696548 38.26112341810949; ...
%              143441.1817530273 6394357.207751897 38.00565783248749];                   

% david
% w_output = [143425.7060847757 6394341.809778472 35.8254541795468; ...
% 143425.6213387786 6394342.198790921 36.75738590757828; ...
% 143425.9221553726 6394343.01877762 36.60048429330345; ...
% 143427.0788233937 6394343.496842822 36.2614647737937; ...
% 143426.8203758195 6394344.523917504 37.63974787830375; ...
% 143423.8547148872 6394348.376707423 35.61277460778365; ...
% 143430.5016557599 6394347.117340458 33.6572561514331; ...
% 143428.5327172012 6394346.689451535 37.57156960922293; ...
% 143427.6966898516 6394348.333398648 36.02265979314689; ...
% 143428.1946601435 6394349.555881571 35.58441123308148];

% % radius search
% w_output = [143425.5458, 6394339.728, 35.4776154; ... 
%             143424.8205, 6394340.213, 37.2237907; ...
%             143426.218, 6394341.563, 34.60970189; ...
%             143427.2086, 6394343.55, 35.30602905; ...
%             143427.1342, 6394343.034, 34.0535811; ...
%             143426.6962, 6394344.134, 35.6169112; ... 
%             143426.5533, 6394344.759, 35.1779440; ... 
%             143426.6285, 6394345.894, 35.6635887; ... 
%             143427.2944, 6394346.462, 35.2829628; ... 
%             143427.0441, 6394347.753, 35.0472081; ... 
%             143428.4532, 6394349.698, 34.6800439; ... 
%             143428.175, 6394350.232, 34.50044262];

% with ROI and SIFT contrast increased
w_output = [ 143426.0636 6394336.865 37.1202488; ...
143426.3393 6394337.657 37.02928687; ...
143426.5977 6394338.508 36.82145254; ...
143426.5255 6394339.078 36.88528404; ...
143426.6204 6394340.032 36.71363119; ...
143426.8696 6394340.974 36.62773421; ...
143427.0806 6394341.7 36.4348254; ...
143427.4051 6394342.882 36.31902591; ...
143427.8043 6394343.931 36.15998374; ...
143428.0889 6394344.8 36.00332207; ...
143428.2943 6394345.407 35.9503648; ...
143428.5695 6394346.484 35.84472918; ...
143428.9321 6394347.619 35.68992245; ...
143429.2862 6394348.291 35.53678739; ...
143429.4251 6394349.042 35.54712544; ...
143429.8436 6394350.122 35.40766763; ...
143430.075 6394350.654 35.34394414; ...
143430.3819 6394351.653 35.20520638; ...
143429.571 6394349.155 35.446105; ...
143429.5733 6394349.508 35.47386497; ...
143429.7586 6394349.923 35.41195793; ...
143429.9227 6394350.396 35.44244723; ...
143430.0781 6394351.001 35.30575414; ...
143429.722 6394349.927 35.40750592; ...
143429.7393 6394349.727 35.40787172; ...
143429.7507 6394349.823 35.39878606; ...
143429.9488 6394350.594 35.33435941; ...
143429.1746 6394348.558 35.63011611; ...
143429.4096 6394348.941 35.70835876; ...
143429.7977 6394350.097 35.38535692; ...
143429.6844 6394349.934 35.44085534; ...
143429.5836 6394349.813 35.49782817; ...
143429.7854 6394350.202 35.42634146; ...
143429.7469 6394350.02 35.39277217; ...
143429.7978 6394350.212 35.42174901; ...
143429.5925 6394349.684 35.46195098; ...
143429.8099 6394350.183 35.36744648; ...
143429.601 6394349.749 35.42741282; ...
143429.5079 6394349.241 35.49731724; ...
143429.6308 6394349.789 35.48640466; ...
143429.5581 6394349.636 35.4523985; ...
143429.6554 6394349.983 35.39081923; ...
143429.099 6394348.483 35.63416076; ...
143429.6764 6394349.835 35.43684164; ...
143429.282 6394348.973 35.54811826; ...
143429.6596 6394349.821 35.52913724; ...
143429.417 6394349.318 35.52256362; ...
143428.9823 6394348.456 35.68845546; ...
143429.4381 6394349.535 35.60788411; ...
143429.5852 6394349.754 35.49830806];

%% plot to pointcloud
tunnel = pointCloud (A);
pcshow (tunnel); hold on;
% plot3 (w_samples(1,:), w_samples(2,:), w_samples(3,:), '.'); hold on;
plot3 (w_output(:,1), w_output(:,2), w_output(:,3), 'x'); hold on;
plot3 (w_output(:,1), w_output(:,2), w_output(:,3));
% plot3 (143424.5954982183, 6394360.846589573, 40.6789214860592, 'x');
% plot3 (143424.0469000000, 6394361.000000000, 40.2150000000000, 'x');
% plot3 (143448.0625, 6394362.5, 41.6405029296875, 'x');
