%% open the .PCD
fileID = fopen('../OPiT/gnistangtunneln-semifull-voxelized.pcd','r');

%% skip the header
for k=1:11
    tline = fgets(fileID);
end

%% set the format
formatSpec = '%f %f %f';
sizeA = [3 Inf];

A = fscanf(fileID,formatSpec,sizeA);
A = A.';

fclose(fileID);

%% try to put something atop the point cloud
w_cameracenter  = [143425.5458; 6394339.7282; 35.4776];
p_minrange      = 10;
p_maxrange      = 25;
p_range         = (12:0.2:26);
p_sample        = [239.8354; 207.1412];

%% C matrix -- calibration matrix
K = [1432, 0, 640;
     0, 1432, 480;
     0, 0, 1];

T = [0.936168046306955, -0.07229943085008331, 0.3440380522159919, 143425.5458462106; ...
     -0.3475265283978696, -0.04263812010476335, 0.9367002203339428, 6394339.728225683; ...
     -0.0530537570162973, -0.9964711651687098, -0.06504241580514886, 35.47761542402441; ...
     0, 0, 0, 1];
 
%% calculate 
size_t = size(p_range, 2);
counter = 1;
w_samples = zeros(4, size_t);

for i = p_range
    c_samplemin     = K \ [i * p_sample(1,1); i * p_sample(2,1); i];
    w_samplemin     = T * [c_samplemin; 1];
%     c_samplemax     = K \ [p_maxrange * p_sample(1,1); p_maxrange * p_sample(2,1); p_maxrange];
%     w_samplemax     = T * [c_samplemax; 1];  
%     w_samples       = [w_samplemin(1:3,:) w_samplemax(1:3,:)];
    w_samples(:,counter)  = w_samplemin;
    counter = counter+1;
end

% threshold 0.1 delta_z 0.1 range [15..25]
% w_output        = [ 143425.5458 6394339.7282 35.4776; ...
%                     143425.7050 6394339.9528 35.5748; ...
%                     143426.4609 6394340.3759 35.3052; ...
%                     143426.2820 6394341.0865 35.1930; ...
%                     143426.6524 6394342.1847 35.0957; ...
%                     143425.9659 6394342.9679 36.4973; ...
%                     143426.6897 6394343.5866 36.4533; ...
%                     143426.7589 6394344.2610 38.3915; ...
%                     143427.5726 6394345.0818 38.2862];

% threshold 0.5 delta_z 0.5 range [15..25]
% w_output        = [ 143425.5458 6394339.7282 35.4776; ...                
%                     143426.1352 6394339.8483 35.5904; ...
%                     143426.4918 6394340.0238, 35.8172; ...
%                     143426.2570 6394340.3981 35.9104; ...
%                     143426.5593 6394341.3152 35.7641; ...
%                     143428.2513 6394342.6331 35.4329; ...
%                     143428.5748 6394343.3893 35.6713; ...
%                     143424.8591 6394346.1549 39.7465; ...
%                     143424.6530 6394347.5601 37.8629; ...
%                     143424.6043 6394349.4692 41.3363]; 
                
% w_output        = [ 143425.5458 6394339.7282 35.4776; ...
%                     143426.8770 6394340.0674 36.4723; ...
%                     143427.1853 6394341.0884 36.0889; ...
%                     143428.2329 6394341.9921 35.6395; ...
%                     143427.7359 6394342.7898 36.0100; ...
%                     143428.1049 6394343.6650 35.9862; ...
%                     143428.8203 6394345.3527 35.2654; ...
%                     
%                     143428.7359 6394345.7898 36.0100; ...
%                     143429.1049 6394346.6650 35.9862; ...
%                     143429.3203 6394347.3527 35.2654];
                    
% w_output =  [143442.7589514623 6394357.384494003 38.45321393071208; ...
%              143441.7918847976 6394357.552393478 38.51032425370067; ...
%              143442.5353419967 6394355.829716453 37.80889172409661; ...
%              143440.5975704645 6394358.049696548 38.26112341810949; ...
%              143441.1817530273 6394357.207751897 38.00565783248749];                   

% david
% w_output = [143425.7060847757 6394341.809778472 35.8254541795468; ...
% 143425.6213387786 6394342.198790921 36.75738590757828; ...
% 143425.9221553726 6394343.01877762 36.60048429330345; ...
% 143427.0788233937 6394343.496842822 36.2614647737937; ...
% 143426.8203758195 6394344.523917504 37.63974787830375; ...
% 143423.8547148872 6394348.376707423 35.61277460778365; ...
% 143430.5016557599 6394347.117340458 33.6572561514331; ...
% 143428.5327172012 6394346.689451535 37.57156960922293; ...
% 143427.6966898516 6394348.333398648 36.02265979314689; ...
% 143428.1946601435 6394349.555881571 35.58441123308148];

% % radius search
% w_output = [143425.5458, 6394339.728, 35.4776154; ... 
%             143424.8205, 6394340.213, 37.2237907; ...
%             143426.218, 6394341.563, 34.60970189; ...
%             143427.2086, 6394343.55, 35.30602905; ...
%             143427.1342, 6394343.034, 34.0535811; ...
%             143426.6962, 6394344.134, 35.6169112; ... 
%             143426.5533, 6394344.759, 35.1779440; ... 
%             143426.6285, 6394345.894, 35.6635887; ... 
%             143427.2944, 6394346.462, 35.2829628; ... 
%             143427.0441, 6394347.753, 35.0472081; ... 
%             143428.4532, 6394349.698, 34.6800439; ... 
%             143428.175, 6394350.232, 34.50044262];

% with ROI and SIFT contrast increased
w_output =  [ 143426.5198 6394340.289 35.7302345; ...
            143426.545 6394341.073 35.64292826; ...
            143426.437 6394341.544 35.42155804; ...
            143427.0364 6394342.6 35.39533947; ...
            143427.4223 6394343.998 35.41930132; ...
            143427.6992 6394345.135 35.47228774; ...
            143427.9939 6394345.973 35.39334323; ...
            143428.1004 6394346.698 35.18911708; ...
            143428.3966 6394347.622 35.38323689; ...
            143428.8291 6394348.275 35.19872441; ...
            143429.0359 6394349.491 35.27340255; ...
            143429.3818 6394350.447 35.23917729; ...
            143429.7357 6394351.356 35.33954745; ...
            143429.764 6394352.267 35.56198996; ...
            143430.3169 6394352.962 35.27445718; ...
            143430.5358 6394353.865 35.20560068; ...
            143431.1634 6394354.877 34.82270037; ...
            143429.8415 6394351.764 35.45137443; ...
            143429.9475 6394352.505 35.61892677; ...
            143430.0598 6394353.231 35.36304258; ...
            143430.7566 6394354.206 35.08262729; ...
            143430.6218 6394354.464 35.31586172; ...
            143430.0236 6394352.763 35.57608071; ...
            143430.1473 6394352.891 35.2244605; ...
            143430.3422 6394353.55 35.59285036; ...
            143430.5244 6394354.273 35.22801217; ...
            143430.8055 6394354.96 35.33600111; ...
            143430.9721 6394355.747 35.42551461; ...
            143429.4908 6394352.247 36.05539243; ...
            143429.8849 6394353.43 35.73882705; ...
            143429.2014 6394352.094 36.41007791; ...
            143430.5654 6394354.908 35.5874818; ...
            143429.7873 6394353.332 36.11286501; ...
            143429.7973 6394353.672 35.96028932; ...
            143429.8978 6394353.602 36.07795656; ...
            143430.1768 6394354.25 35.89957517; ...
            143430.5856 6394355.483 35.73392835; ...
            143430.3818 6394354.864 35.71132525; ...
            143430.5946 6394355.566 35.66758688; ...
            143430.4896 6394355.942 35.93789802; ...
            143430.1624 6394354.891 36.00439037; ...
            143430.8238 6394356.311 35.69632785; ...
            143431.1289 6394357.015 35.4106479; ...
            143426.9983 6394350.544 38.21257577; ...
            143430.6775 6394356.401 35.88179172; ...
            143427.6265 6394351.445 37.68400039; ...
            143428.1813 6394352.719 37.771468; ...
            143428.2898 6394353.346 37.66864168; ...
            143429.4524 6394355.467 37.19119196; ...
            143429.1126 6394355.336 37.56212702; ...
            143429.7465 6394355.816 37.28471398; ...
            143429.6336 6394355.775 37.16260501; ...
            143430.3386 6394357.188 36.67162778; ...
            143430.4987 6394357.48 36.85160451; ...
            143430.422 6394357.447 36.81359571; ...
            143430.582 6394357.901 36.80312356; ...
            143431.2212 6394359.225 36.57973639; ...
            143429.8033 6394357.608 37.70679321; ...
            143431.9085 6394360.158 36.21872486; ...
            143428.5201 6394357.38 38.91257872; ...
            143429.0216 6394358.789 38.89878648; ...
            143429.9321 6394359.565 38.28660947; ...
            143429.6202 6394359.177 38.69126224; ...
            143430.1692 6394359.547 38.31662396; ...
            143429.9387 6394360.09 38.67484842; ...
            143430.4327 6394360.91 38.30999326; ...
            143427.8715 6394360.119 43.31042028; ...
            143427.5826 6394360.879 43.53414166; ...
            143427.9454 6394361.863 43.01344541; ...
            143427.8562 6394362.068 43.58500961; ...
            143429.0578 6394362.411 42.07239502; ...
            143429.5028 6394363.024 41.87365472; ...
            143428.8117 6394363.217 42.48961392; ...
            143429.4334 6394363.425 41.63103738; ...
            143430.1024 6394363.266 40.96809716; ...
            143429.6013 6394363.413 41.53567083; ...
            143429.0985 6394365.029 41.89589175; ...
            143433.4491 6394364.373 43.6514013; ...
            143426.5805 6394368.821 42.48955552; ...
            143430.4754 6394367.68 42.51183783; ...
            143430.3441 6394367.47 41.57155121; ...
            143431.8216 6394368.737 42.09809563; ...
            143431.5506 6394373.473 42.84107045; ...
            143431.9776 6394366.268 39.76799409; ...
            143432.886 6394369.414 40.95217998; ...
            143427.1417 6394370.226 41.31063307; ...
            143428.28 6394373.045 40.65920928; ...
            143427.4265 6394371.795 40.19950203; ...
            143429.3119 6394372.622 40.48986119; ...
            143428.1335 6394372.054 39.59170216; ...
            143433.0186 6394376.679 38.22296422; ...
            143429.0773 6394372.147 37.20866257; ...
            143430.2295 6394376.702 37.73607208; ...
            143430.9334 6394375.212 37.61870587; ...
            143429.3373 6394376.375 36.87126784; ...
            143433.874 6394376.271 35.4767879; ...
            143432.0094 6394376.313 35.13241395; ...
            143428.3213 6394371.611 27.57827288; ...
            143432.9572 6394375.66 32.22196895; ...
            143430.8028 6394378.243 33.81010504; ...
            143413.8409 6394332.911 48.33981474; ...
            143414.0917 6394334.824 48.12974425; ...
            143414.9691 6394336.031 47.9005293; ...
            143415.7292 6394337.203 47.0430172; ...
            143415.7653 6394340.96 46.90866286; ...
            143416.5092 6394339.321 46.4963064; ...
            143416.982 6394341.407 46.41270857; ...
            143417.0657 6394340.263 44.91095289; ...
            143417.1463 6394341.874 45.15969162; ...
            143417.7196 6394340.661 44.26959416; ...
            143418.0782 6394341.92 44.09205404; ...
            143419.3485 6394340.902 44.41327987; ...
            143417.8991 6394341.503 43.08790811; ...
            143418.7804 6394343.107 43.54502887; ...
            143419.0078 6394343.4 43.48574366; ...
            143419.2485 6394344.221 42.71649489; ...
            143420.7494 6394345.093 41.81089776; ...
            143420.6081 6394346.544 41.41218934; ...
            143420.6382 6394345.935 41.82809573; ...
            143421.3534 6394345.345 40.60421437; ...
            143421.5019 6394346.16 40.81988278; ...
            143422.3277 6394346.253 40.36587015; ...
            143421.7938 6394346.521 40.85509001; ...
            143422.4805 6394347.286 40.5159412; ...
            143422.6086 6394347.103 40.66560944; ...
            143422.7024 6394347.726 40.29757228; ...
            143423.5492 6394348.147 39.67258714; ...
            143423.8072 6394348.557 39.66283818; ...
            143422.825 6394348.339 40.41419519; ...
            143423.5039 6394348.611 39.63016826; ...
            143424.3291 6394350.555 38.84966462; ...
            143424.2091 6394350.743 39.09982513; ...
            143424.5679 6394350.858 39.29876817; ...
            143425.1783 6394350.692 38.55845853; ...
            143424.7703 6394351.226 38.85578389; ...
            143425.2487 6394351.362 38.46955649; ...
            143425.7967 6394352.553 38.5432512; ...
            143426.1091 6394353.291 38.26860392; ...
            143425.7649 6394351.942 38.22176679; ...
            143426.5906 6394352.794 38.54601729; ...
            143427.1534 6394354.115 37.75161068; ...
            143426.7384 6394353.812 37.40190077; ...
            143426.7244 6394353.83 37.94320714; ...
            143427.344 6394354.108 38.04979389; ...
            143427.0243 6394354.965 37.19301506; ...
            143428.7483 6394355.061 36.62146242; ...
            143425.5018 6394354.326 37.04466286; ...
            143425.4666 6394356.465 39.65365866; ...
            143428.084 6394355.682 37.01287212; ...
            143428.423 6394355.676 36.83483199; ...
            143427.7651 6394356.279 37.15076861; ...
            143428.6952 6394357.194 37.34360232; ...
            143428.3462 6394356.48 36.15480325; ...
            143428.5347 6394356.388 36.63734482; ...
            143430.5154 6394358.708 35.81364121; ...
            143431.167 6394358.705 36.20758057; ...
            143430.4717 6394357.432 36.05138006; ...
            143431.0892 6394359.594 35.86391886; ...
            143432.8175 6394359.911 35.17939999; ...
            143431.1419 6394358.358 35.75445973; ...
            143433.83 6394359.411 34.21960158; ...
            143434.7187 6394359.597 34.00394335; ...
            143435.0619 6394360.659 33.73804055; ...
            143435.0434 6394360.559 33.65519282; ...
            143423.371 6394357.26 38.52201691; ...
            143424.8318 6394357.244 38.27718583; ...
            143424.8395 6394357.239 39.52938401; ...
            143423.6934 6394358.931 38.65947095; ...
            143423.9709 6394359.696 38.92026066; ...
            143423.4884 6394359.857 38.61311162; ...
            143422.5363 6394363.507 37.24135735; ...
            143423.5474 6394362.596 36.13046617; ...
            143423.5251 6394362.942 34.32384868; ...
            143425.1923 6394361.67 34.23349152; ...
            143425.2826 6394361.136 32.49855359; ...
            143424.4508 6394362.448 34.60732152; ...
            143426.6911 6394362.127 33.7859055; ...
            143426.1277 6394361.396 33.9701445; ...
            143426.4392 6394362.013 33.7880782; ...
            143422.4864 6394363.737 34.31030717; ...
            143422.9982 6394364.79 34.98089012; ...
            143424.8053 6394363.663 33.3948552; ...
            143424.3249 6394363.988 34.13577722; ...
            143423.7247 6394366.057 34.29394859; ...
            143423.8726 6394364.095 33.37626545; ...
            143425.723 6394363.598 33.92332189; ...
            143424.7163 6394363.166 32.52256157; ...
            143425.7326 6394363.58 33.34542318; ...
            143426.0564 6394362.894 33.724383; ...
            143426.8097 6394363.926 33.66738708; ...
            143426.8894 6394368.78 33.09204951; ...
            143427.0132 6394367.057 33.21534278; ...
            143427.6221 6394368.745 33.18005853; ...
            143428.6141 6394368.707 32.99208909; ...
            143429.8299 6394368.523 32.92706576; ...
            143426.5502 6394372.57 32.86605518; ...
            143426.9571 6394372.214 33.03597386; ...
            143426.623 6394371.22 33.25727857; ...
            143428.047 6394373.045 33.82848113; ...
            143426.8622 6394371.382 33.26478369; ...
            143427.5429 6394373.99 33.35908386; ...
            143428.6487 6394373.212 32.85818609; ...
            143427.6133 6394372.669 33.24830719; ...
            143428.5926 6394370.962 31.94175943; ...
            143428.9476 6394371.272 32.10679339; ...
            143428.0944 6394371.483 32.06976304; ...
            143428.3466 6394371.346 32.14416143; ...
            143428.7415 6394370.62 32.09401383; ...
            143429.3384 6394370.183 32.24927775; ...
            143429.2511 6394371.21 32.32689531; ...
            143429.161 6394373.24 31.85860202; ...
            143429.8239 6394372.157 31.27581579; ...
            143431.0232 6394370.068 32.06959019; ...
            143429.6936 6394372.851 31.80144836; ...
            143430.1738 6394371.376 31.96061379; ...
            143430.6642 6394371.308 31.70300817; ...
            143430.9633 6394370.249 32.09563747; ...
            143430.2123 6394373.11 31.78648142; ...
            143431.921 6394371.569 31.58431576; ...
            143431.7464 6394370.181 32.44991479; ...
            143432.9317 6394372.795 32.48885099; ...
            143431.8056 6394373.012 32.63052299; ...
            143435.9921 6394374.676 32.44018012; ...
            143432.5521 6394371.178 30.13690182; ...
            143435.9065 6394372.327 28.37166877; ...
            143440.0535 6394373.203 29.95308958; ...
            143439.9161 6394372.772 30.56793224; ...
            143440.0486 6394372.049 30.58221357; ...
            143442.1959 6394371.852 30.52043965; ...
            143440.5484 6394371.07 30.92837093; ...
            143440.7882 6394370.76 30.99907942; ...
            143440.9474 6394369.267 31.3329646; ...
            143440.8986 6394369.751 31.07822955; ...
            143440.75 6394368.879 31.28195727; ...
            143440.7989 6394368.645 31.39930913; ...
            143441.1739 6394367.48 31.79650595; ...
            143440.6647 6394367.48 31.69200576; ...
            143440.8405 6394365.817 32.17586529; ...
            143440.8701 6394365.677 32.45551372; ...
            143441.0176 6394363.858 32.59216207; ...
            143441.2723 6394363.14 32.95357916; ...
            143441.0598 6394362.687 33.22009145; ...
            143440.7179 6394361.893 33.05356048; ...
            143440.5963 6394362.043 33.04578667; ...
            143440.9692 6394361.791 33.15295549; ...
            143441.2049 6394359.9 32.96199006; ...
            143441.031 6394360.343 33.52687352; ...
            143440.9828 6394359.302 33.58238435; ...
            143440.6621 6394358.259 33.85530382; ...
            143441.0712 6394356.813 34.4135317];

%% plot to pointcloud
tunnel = pointCloud (A);
pcshow (tunnel); hold on;
% plot3 (w_samples(1,:), w_samples(2,:), w_samples(3,:), '.'); hold on;
plot3 (w_output(:,1), w_output(:,2), w_output(:,3), 'x'); hold on;
plot3 (w_output(:,1), w_output(:,2), w_output(:,3));
% plot3 (143424.5954982183, 6394360.846589573, 40.6789214860592, 'x');
% plot3 (143424.0469000000, 6394361.000000000, 40.2150000000000, 'x');
% plot3 (143448.0625, 6394362.5, 41.6405029296875, 'x');
